@page "/seat-selection/{eventName}"
@using Microsoft.AspNetCore.Components
@inject NavigationManager Navigation

<h2 class="text-center mt-4">Seat Map</h2>
<p class="text-center">Availability for event.</p>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h4>Seat Map</h4>
            <div class="seat-map">
                @for (int row = 0; row < seatRows; row++)
                {
                    <div class="seat-row">
                        @for (int col = 0; col < seatCols; col++)
                        {
                            var seatId = $"{(char)('A' + row)}{col + 1}";
                            var isBooked = bookedSeats.Contains(seatId);
                            <div class="seat" style="background-color:@(isBooked ? "#FF0000" : "#FFFFFF"); color:@(isBooked ? "white" : "black");">@seatId</div>
                        }
                    </div>
                }
            </div>
        </div>
        <div class="col-md-4">
            <h4>Select Your Seats</h4>
            <input type="text" class="form-control" placeholder="Enter seat IDs (e.g., A1, B3)" @bind="seatInput" />
            <button class="btn btn-primary mt-2" @onclick="SubmitSelection">Confirm Selection</button>

            <!-- Display selected seats in a textbox -->
            <div class="mt-3">
                <label>Selected Seats:</label>
                <input type="text" class="form-control" value="@string.Join(", ", selectedSeats)" disabled />
            </div>

            <!-- Display the total amount for selected seats -->
            <div class="mt-3">
                <label>Total Amount:</label>
                <input type="text" class="form-control" value="@totalAmount" disabled />
            </div>

            <!-- Button to navigate to the payment page with totalAmount -->
            <button class="btn btn-primary w-100 mt-3" @onclick="GoToPaymentPage">Proceed to Payment</button>
        </div>
    </div>
</div>

<style>
    .seat {
        width: 40px;
        height: 40px;
        margin: 5px;
        text-align: center;
        border-radius: 5px;
        border: 1px solid #000;
        display: inline-block;
        line-height: 40px;
    }

    .available {
        background-color: #FFFFFF;
    }

    .booked {
        background-color: #FF0000;
        color: white;
    }
</style>

@code {
    [Parameter] public string EventName { get; set; }

    private int seatRows = 5;
    private int seatCols = 10;
    private List<string> bookedSeats = new(); // This will come from the database
    private List<string> selectedSeats = new();
    private string seatInput = "";
    public decimal totalAmount = 0; // Initialize to 0

    private void SubmitSelection()
    {
        // Split the input seat IDs, trim spaces, and convert to uppercase
        var seats = seatInput.Split(',').Select(s => s.Trim().ToUpper()).Where(s => !string.IsNullOrEmpty(s));

        foreach (var seat in seats)
        {
            if (IsValidSeat(seat) && !bookedSeats.Contains(seat) && !selectedSeats.Contains(seat))
            {
                selectedSeats.Add(seat);
                // Every time a valid seat is added, $10 is added to the total amount
                totalAmount += 10;
            }
        }

        // Clear input field after selection
        seatInput = "";

        // Optionally, you could call a method here to save the selection to the database
        SaveSelectionToDatabase();
    }

    private bool IsValidSeat(string seat)
    {
        // Valid seat pattern is: A1, A2, ..., A10, B1, B2, ..., B10, etc.
        var validSeats = new List<string>();

        for (int row = 0; row < seatRows; row++)
        {
            for (int col = 1; col <= seatCols; col++)
            {
                validSeats.Add($"{(char)('A' + row)}{col}");
            }
        }

        return validSeats.Contains(seat);
    }

    private void GoToPaymentPage()
    {
        // Navigate to the payment page with the totalAmount query parameter
        Navigation.NavigateTo($"/payment?totalAmount={totalAmount}");
    }

    private void SaveSelectionToDatabase()
    {
        // TODO: Implement database logic to save selectedSeats for this event
    }
}
