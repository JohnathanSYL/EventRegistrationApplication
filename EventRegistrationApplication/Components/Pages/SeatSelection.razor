@page "/seat-selection/{eventName}"
@using EventRegistrationApplication.Data
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@inject EventRegistrationApplicationContext DbContext
@inject NavigationManager Navigation

<h2 class="text-center mt-4">Seat Map</h2>
<p class="text-center">Availability for @EventName</p>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h4>Seat Map</h4>
            <div class="seat-map">
                @for (int row = 0; row < seatRows; row++)
                {
                    <div class="seat-row">
                        @for (int col = 0; col < seatCols; col++)
                        {
                            var seatId = $"{(char)('A' + row)}{col + 1}";
                            var isBooked = bookedSeats.Contains(seatId);
                            var statusClass = isBooked ? "booked" : "available";
                            var seatPrice = GetSeatPrice(row);
                            <div class="seat @statusClass" title="$@seatPrice">@seatId ($@seatPrice)</div>
                        }
                    </div>
                }
            </div>
        </div>
        <div class="col-md-4">
            <h4>Select Your Seats</h4>
            <input type="text" class="form-control" placeholder="Enter seat IDs (e.g., A1, B3)" @bind="seatInput" />
            <button class="btn btn-primary mt-2" @onclick="SubmitSelection">Confirm Selection</button>
            <ul class="mt-3">
                @foreach (var seat in selectedSeats)
                {
                    <li>@seat</li>
                }
            </ul>
            <h5 class="mt-3">Total Price: $@TotalPrice</h5>
            <button class="btn btn-success mt-2" @onclick="ProceedToPayment">Proceed to Payment</button>
        </div>
    </div>
</div>

<style>
    .seat {
        width: 40px;
        height: 40px;
        margin: 5px;
        text-align: center;
        border-radius: 5px;
        border: 1px solid #000;
        display: inline-block;
        line-height: 40px;
    }

    .available {
        background-color: green;
    }

    .booked {
        background-color: red;
        color: white;
    }
</style>

@code {
    @using SeatSelectionModel = EventRegistrationApplication.Domain.SeatSelection
    [Parameter] public string EventName { get; set; }

    private int seatRows = 5;
    private int seatCols = 10;
    private List<string> bookedSeats = new(); // This will come from the database
    private List<string> selectedSeats = new();
    private string seatInput = "";
    private int TotalPrice => selectedSeats.Sum(s => GetSeatPrice(s[0] - 'A'));

    protected override async Task OnInitializedAsync()
    {
        bookedSeats = await DbContext.SeatSelections
            .Where(s => s.Event.EventName == EventName && s.SeatStatus.StatusName != "Available")
            .Select(s => s.GridCoordinates)
            .ToListAsync();
    }

    private int GetSeatPrice(int row)
    {
        return 100 + (row * 20); // Example pricing logic
    }

    private async Task SubmitSelection()
    {
        var seats = seatInput.Split(',').Select(s => s.Trim().ToUpper()).Where(s => !string.IsNullOrEmpty(s));
        foreach (var seat in seats)
        {
            if (!bookedSeats.Contains(seat) && !selectedSeats.Contains(seat))
            {
                selectedSeats.Add(seat);
                var seatSelection = new SeatSelectionModel
                    {
                        GridCoordinates = seat,
                        EventId = await GetEventId(EventName),
                        SeatStatusId = 2, // Assuming 2 means "Reserved"
                        UserId = 1, // Replace with actual logged-in user ID
                        SeatPrice = GetSeatPrice(seat[0] - 'A')
                    };
                DbContext.SeatSelections.Add(seatSelection);
            }
        }
        await DbContext.SaveChangesAsync();
        seatInput = "";
        bookedSeats.AddRange(selectedSeats);
    }

    private async Task<int> GetEventId(string eventName)
    {
        return await DbContext.EventModel.Where(e => e.EventName == eventName).Select(e => e.EventId).FirstOrDefaultAsync();
    }

    private void ProceedToPayment()
    {
        var seatsParam = string.Join(",", selectedSeats);
        Navigation.NavigateTo($"/payment?seats={seatsParam}&total={TotalPrice}");
    }
}
